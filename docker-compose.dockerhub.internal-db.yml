services:
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: yuebot
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD?POSTGRES_PASSWORD is required}"
      POSTGRES_DB: yuebot
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U yuebot -d yuebot -h localhost"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    volumes:
      - yuebot_db_data:/var/lib/postgresql/data

  yuebot:
    build:
      context: .
    image: isyuricunha/yue-discord-bot:latest
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "${HOST_WEB_PORT:-80}:80"
      - "${HOST_API_PORT:-3000}:3000"
    environment:
      NODE_ENV: production
      LOG_LEVEL: info

      ENABLE_BOT: "${ENABLE_BOT:-true}"

      API_PORT: "3000"
      API_HOST: "0.0.0.0"
      TRUST_PROXY: "0"
      API_BODY_LIMIT: "10485760"

      POSTGRES_USER: yuebot
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD?POSTGRES_PASSWORD is required}"
      POSTGRES_DB: yuebot
      DATABASE_URL: "${DATABASE_URL:-postgresql://yuebot:${POSTGRES_PASSWORD}@db:5432/yuebot}"

      DISCORD_TOKEN: "${DISCORD_TOKEN-}"
      DISCORD_BOT_TOKEN: "${DISCORD_BOT_TOKEN-}"
      DISCORD_CLIENT_ID: "${DISCORD_CLIENT_ID?DISCORD_CLIENT_ID is required}"
      DISCORD_CLIENT_SECRET: "${DISCORD_CLIENT_SECRET?DISCORD_CLIENT_SECRET is required}"
      DISCORD_REDIRECT_URI: "${DISCORD_REDIRECT_URI?DISCORD_REDIRECT_URI is required}"

      JWT_SECRET: "${JWT_SECRET?JWT_SECRET is required}"
      JWT_EXPIRES_IN: "${JWT_EXPIRES_IN:-7d}"

      INTERNAL_API_SECRET: "${INTERNAL_API_SECRET?INTERNAL_API_SECRET is required}"
      BOT_INTERNAL_HOST: "${BOT_INTERNAL_HOST:-127.0.0.1}"
      BOT_INTERNAL_PORT: "${BOT_INTERNAL_PORT:-3100}"
      INTERNAL_API_CACHE_TTL_MS: "${INTERNAL_API_CACHE_TTL_MS:-20000}"
      INTERNAL_API_CACHE_MAX_ENTRIES: "${INTERNAL_API_CACHE_MAX_ENTRIES:-500}"

      CORS_ORIGINS: "${CORS_ORIGINS?CORS_ORIGINS is required}"

      COOKIE_SAMESITE: "${COOKIE_SAMESITE:-lax}"
      COOKIE_SECURE: "${COOKIE_SECURE:-false}"
      COOKIE_DOMAIN: "${COOKIE_DOMAIN-}"

      WEB_URL: "${WEB_URL?WEB_URL is required}"
      FRONTEND_URL: "${FRONTEND_URL:-${WEB_URL}}"

      VITE_API_URL: "${VITE_API_URL-}"
      VITE_DISCORD_CLIENT_ID: "${VITE_DISCORD_CLIENT_ID:-${DISCORD_CLIENT_ID}}"

      BADGE_ADMIN_USER_IDS: "${BADGE_ADMIN_USER_IDS-}"
      FAN_ART_REVIEWER_USER_IDS: "${FAN_ART_REVIEWER_USER_IDS-}"
      OWNER_USER_IDS: "${OWNER_USER_IDS-}"
      GLOBAL_XP_RESET_USER_IDS: "${GLOBAL_XP_RESET_USER_IDS-}"

volumes:
  yuebot_db_data:
