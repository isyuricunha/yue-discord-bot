name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  checks:
    name: lint, type-check, build
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Security - fail on committed secrets
        run: |
          set -euo pipefail

          echo "Checking for committed .env files (non-example)..."
          env_files=$(git ls-files | grep -E '(^|/)\.env($|\.)' | grep -v -E '\.example$' || true)
          if [ -n "$env_files" ]; then
            echo "ERROR: committed .env files detected:"
            echo "$env_files"
            exit 1
          fi

          echo "Checking for committed private key files..."
          key_files=$(git ls-files | grep -E '(\.(pem|key|p12)$|(^|/)id_rsa($|\.)|(^|/)id_ed25519($|\.))' || true)
          if [ -n "$key_files" ]; then
            echo "ERROR: committed key files detected:"
            echo "$key_files"
            exit 1
          fi

          echo "Checking for private key markers in tracked files..."
          if git grep -n "BEGIN PRIVATE KEY" -- .; then
            echo "ERROR: private key marker detected in tracked file(s)."
            exit 1
          fi

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Type-check
        run: pnpm type-check

      - name: Build
        run: pnpm build
