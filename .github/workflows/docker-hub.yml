name: Docker Hub

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - "README.md"
      - "LICENSE"
      - "LICENSE.txt"
      - ".env.example"
      - ".env.docker.example"
      - ".env.local.example"
      - "apps/web/.env.example"
      - "**/*.md"
      - "docker-compose*.yml"
      - ".github/**/*.md"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  packages: write

jobs:
  push_to_registry:
    name: Push Docker image to Docker Hub
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Type-check
        run: pnpm type-check

      - name: Test
        run: pnpm -r --if-present run test

      - name: Build
        run: pnpm build

      - name: Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        if: steps.semantic.outputs.new_release_published == 'true'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: steps.semantic.outputs.new_release_published == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: steps.semantic.outputs.new_release_published == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        if: steps.semantic.outputs.new_release_published == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        if: steps.semantic.outputs.new_release_published == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/yue-discord-bot:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/yue-discord-bot:${{ steps.semantic.outputs.new_release_git_tag }}
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ steps.semantic.outputs.new_release_git_tag }}
          labels: |
            org.opencontainers.image.title=Yue Discord Bot
            org.opencontainers.image.description=A biggest bot.
            org.opencontainers.image.version=${{ steps.semantic.outputs.new_release_git_tag }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.repositoryUrl }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Pull fat image (amd64)
        if: steps.semantic.outputs.new_release_published == 'true'
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          VERSION: ${{ steps.semantic.outputs.new_release_git_tag }}
        run: |
          set -euo pipefail
          docker pull --platform linux/amd64 "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}"
          docker tag "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}" "yue-discord-bot:${VERSION}-fat-amd64"

      - name: Slim image (amd64)
        if: steps.semantic.outputs.new_release_published == 'true'
        uses: kitabisa/docker-slim-action@v1
        env:
          DSLIM_HTTP_PROBE: false
        with:
          target: yue-discord-bot:${{ steps.semantic.outputs.new_release_git_tag }}-fat-amd64
          tag: ${{ steps.semantic.outputs.new_release_git_tag }}-slim-amd64

      - name: Pull fat image (arm64)
        if: steps.semantic.outputs.new_release_published == 'true'
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          VERSION: ${{ steps.semantic.outputs.new_release_git_tag }}
        run: |
          set -euo pipefail
          docker pull --platform linux/arm64 "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}"
          docker tag "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}" "yue-discord-bot:${VERSION}-fat-arm64"

      - name: Slim image (arm64)
        if: steps.semantic.outputs.new_release_published == 'true'
        uses: kitabisa/docker-slim-action@v1
        env:
          DSLIM_HTTP_PROBE: false
        with:
          target: yue-discord-bot:${{ steps.semantic.outputs.new_release_git_tag }}-fat-arm64
          tag: ${{ steps.semantic.outputs.new_release_git_tag }}-slim-arm64

      - name: Push slim images (arch tags)
        if: steps.semantic.outputs.new_release_published == 'true'
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          REPO: ${{ github.repository }}
          VERSION: ${{ steps.semantic.outputs.new_release_git_tag }}
        run: |
          set -euo pipefail

          for arch in amd64 arm64; do
            docker tag "yue-discord-bot:${VERSION}-slim-${arch}" "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}-slim-${arch}"
            docker push "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}-slim-${arch}"

            docker tag "yue-discord-bot:${VERSION}-slim-${arch}" "ghcr.io/${REPO}:${VERSION}-slim-${arch}"
            docker push "ghcr.io/${REPO}:${VERSION}-slim-${arch}"
          done

      - name: Create and push slim manifests (multi-arch tags)
        if: steps.semantic.outputs.new_release_published == 'true'
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          REPO: ${{ github.repository }}
          VERSION: ${{ steps.semantic.outputs.new_release_git_tag }}
        run: |
          set -euo pipefail

          docker buildx imagetools create \
            --tag "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}-slim" \
            "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}-slim-amd64" \
            "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}-slim-arm64"

          docker buildx imagetools create \
            --tag "${DOCKERHUB_USERNAME}/yue-discord-bot:latest-slim" \
            "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}-slim-amd64" \
            "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}-slim-arm64"

          docker buildx imagetools create \
            --tag "ghcr.io/${REPO}:${VERSION}-slim" \
            "ghcr.io/${REPO}:${VERSION}-slim-amd64" \
            "ghcr.io/${REPO}:${VERSION}-slim-arm64"

          docker buildx imagetools create \
            --tag "ghcr.io/${REPO}:latest-slim" \
            "ghcr.io/${REPO}:${VERSION}-slim-amd64" \
            "ghcr.io/${REPO}:${VERSION}-slim-arm64"
