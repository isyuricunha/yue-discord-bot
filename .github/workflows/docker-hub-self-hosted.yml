name: Docker Hub (self-hosted)

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - "README.md"
      - "LICENSE"
      - "LICENSE.txt"
      - ".env.example"
      - ".env.docker.example"
      - ".env.local.example"
      - "apps/web/.env.example"
      - "**/*.md"
      - "docker-compose*.yml"
      - ".github/**/*.md"
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - "README.md"
      - "LICENSE"
      - "LICENSE.txt"
      - ".env.example"
      - ".env.docker.example"
      - ".env.local.example"
      - "apps/web/.env.example"
      - "**/*.md"
      - "docker-compose*.yml"
      - ".github/**/*.md"

permissions:
  contents: write
  packages: write

jobs:
  push_to_registry:
    name: Push Docker image to Docker Hub
    runs-on: [self-hosted, Linux, X64, hel, docker]
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag and generate new version
        id: version
        run: |
          # Find the latest tag following v*.*.* pattern
          LATEST_TAG=$(git tag -l "v*.*.*" | sort -V | tail -n1)
          
          if [ -z "$LATEST_TAG" ]; then
            # If no tags exist, start with v1.0.0
            NEW_TAG="v1.0.0"
          else
            # Extract version numbers
            VERSION_PART=$(echo $LATEST_TAG | sed 's/v//')
            MAJOR=$(echo $VERSION_PART | cut -d. -f1)
            MINOR=$(echo $VERSION_PART | cut -d. -f2)
            PATCH=$(echo $VERSION_PART | cut -d. -f3)
            
            # Increment patch version
            NEW_PATCH=$((PATCH + 1))
            NEW_TAG="v${MAJOR}.${MINOR}.${NEW_PATCH}"
          fi
          
          # Create version without 'v' prefix for Docker tags
          DOCKER_VERSION=$(echo $NEW_TAG | sed 's/v//')
          
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "docker_version=$DOCKER_VERSION" >> $GITHUB_OUTPUT
          echo "Latest tag: $LATEST_TAG"
          echo "New tag: $NEW_TAG"
          echo "Docker version: $DOCKER_VERSION"

      - name: Generate release notes
        id: notes
        env:
          LATEST_TAG: ${{ steps.version.outputs.latest_tag }}
          NEW_TAG: ${{ steps.version.outputs.new_tag }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          if [ -z "$LATEST_TAG" ]; then
            title="$NEW_TAG"
            header="## Changes"
            compare_url=""
            log=$(git log --pretty=format:'- %s (%h)')
          else
            title="$NEW_TAG"
            header="## Changes since $LATEST_TAG"
            compare_url="https://github.com/$REPO/compare/$LATEST_TAG...$NEW_TAG"
            log=$(git log "$LATEST_TAG..HEAD" --pretty=format:'- %s (%h)')
          fi

          if [ -z "$log" ]; then
            log='- (no changes found)'
          fi

          {
            echo "title<<EOF"
            printf '%s\n' "$title"
            echo "EOF"
            echo "body<<EOF"
            printf '%s\n' "$header"
            printf '%s\n' "$log"
            if [ -n "$compare_url" ]; then
              printf '\n%s\n' "$compare_url"
            fi
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create and push new tag
        if: github.event_name != 'pull_request'
        env:
          TAG_NAME: ${{ steps.version.outputs.new_tag }}
          TAG_MESSAGE: ${{ steps.notes.outputs.body }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          printf '%s\n' "$TAG_MESSAGE" | git tag -a "$TAG_NAME" -F -
          git push origin "$TAG_NAME"

      - name: Create GitHub Release
        if: github.event_name != 'pull_request'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.new_tag }}
          name: ${{ steps.notes.outputs.title }}
          body: ${{ steps.notes.outputs.body }}

      - name: Set up QEMU
        if: github.event_name != 'pull_request'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/yue-discord-bot:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/yue-discord-bot:${{ steps.version.outputs.docker_version }}
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ steps.version.outputs.docker_version }}
          labels: |
            org.opencontainers.image.title=Yue Discord Bot
            org.opencontainers.image.description=A biggest bot.
            org.opencontainers.image.version=${{ steps.version.outputs.new_tag }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.repositoryUrl }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Pull fat image (amd64)
        if: github.event_name != 'pull_request'
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          VERSION: ${{ steps.version.outputs.docker_version }}
        run: |
          set -euo pipefail
          docker pull --platform linux/amd64 "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}"
          docker tag "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}" "yue-discord-bot:${VERSION}-fat-amd64"

      - name: Slim image (amd64)
        if: github.event_name != 'pull_request'
        uses: kitabisa/docker-slim-action@v1
        env:
          DSLIM_HTTP_PROBE: false
        with:
          target: yue-discord-bot:${{ steps.version.outputs.docker_version }}-fat-amd64
          tag: ${{ steps.version.outputs.docker_version }}-slim-amd64

      - name: Pull fat image (arm64)
        if: github.event_name != 'pull_request'
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          VERSION: ${{ steps.version.outputs.docker_version }}
        run: |
          set -euo pipefail
          docker pull --platform linux/arm64 "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}"
          docker tag "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}" "yue-discord-bot:${VERSION}-fat-arm64"

      - name: Slim image (arm64)
        if: github.event_name != 'pull_request'
        uses: kitabisa/docker-slim-action@v1
        env:
          DSLIM_HTTP_PROBE: false
        with:
          target: yue-discord-bot:${{ steps.version.outputs.docker_version }}-fat-arm64
          tag: ${{ steps.version.outputs.docker_version }}-slim-arm64

      - name: Push slim images (arch tags)
        if: github.event_name != 'pull_request'
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          REPO: ${{ github.repository }}
          VERSION: ${{ steps.version.outputs.docker_version }}
        run: |
          set -euo pipefail

          for arch in amd64 arm64; do
            docker tag "yue-discord-bot:${VERSION}-slim-${arch}" "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}-slim-${arch}"
            docker push "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}-slim-${arch}"

            docker tag "yue-discord-bot:${VERSION}-slim-${arch}" "ghcr.io/${REPO}:${VERSION}-slim-${arch}"
            docker push "ghcr.io/${REPO}:${VERSION}-slim-${arch}"
          done

      - name: Create and push slim manifests (multi-arch tags)
        if: github.event_name != 'pull_request'
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          REPO: ${{ github.repository }}
          VERSION: ${{ steps.version.outputs.docker_version }}
        run: |
          set -euo pipefail

          docker buildx imagetools create \
            --tag "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}-slim" \
            "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}-slim-amd64" \
            "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}-slim-arm64"

          docker buildx imagetools create \
            --tag "${DOCKERHUB_USERNAME}/yue-discord-bot:latest-slim" \
            "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}-slim-amd64" \
            "${DOCKERHUB_USERNAME}/yue-discord-bot:${VERSION}-slim-arm64"

          docker buildx imagetools create \
            --tag "ghcr.io/${REPO}:${VERSION}-slim" \
            "ghcr.io/${REPO}:${VERSION}-slim-amd64" \
            "ghcr.io/${REPO}:${VERSION}-slim-arm64"

          docker buildx imagetools create \
            --tag "ghcr.io/${REPO}:latest-slim" \
            "ghcr.io/${REPO}:${VERSION}-slim-amd64" \
            "ghcr.io/${REPO}:${VERSION}-slim-arm64"
